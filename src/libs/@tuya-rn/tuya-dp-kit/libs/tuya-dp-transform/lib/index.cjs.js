"use strict";var e=require("lodash");const t=[],n=n=>{var e;"development"===(null==(e=null===process||void 0===process?void 0:process.env)?void 0:e.NODE_ENV)&&(console.warn("警告：",n.message),console.warn("相关数据：",n.data)),t.forEach(e=>{e(n)})},r=(t,n)=>{var{defaultValue:r,type:a="number",extension:s}=t;if(void 0!==r)return r;var i=2*o(t,n);switch(a){case"number":case"numberBySeparate":if(s){const e=s["min"];return void 0===e?0:e}return 0;case"string":return e.padStart("00",i,"0");case"boolean":return!1;case"enum":if(s){const e=s["range"];return Array.isArray(e)&&e.length?e[0]:0}return 0;case"week":return[0,0,0,0,0,0,0];case"bit":return[...new Array(i).keys()].map(()=>0);case"child":return{};default:return}},o=(t,n)=>{var{bytes:t=1}=t;let r=t;return(r=!Array.isArray(t)&&"string"!=typeof t?r:e.get(n,t,1))||1},s=(e,t,n)=>{var r=t["extension"],n=e.nextNumber(t,n);if(r){const{min:e=-1/0,max:t=1/0}=r;return Math.max(Math.min(n,t),e)}return n},a=(e,t,n)=>e.nextBits(t,n);class i{constructor(e,t){this.code=e,this.msg=t}}i.ALLREADY_TO_END="endError",i.UNKOWN_CONDITION="unkownConditionError";const u=(s,t,n)=>{var{operation:r="eq",value:a}=s,o=((t,n)=>{var r,{findType:a,prop:o}=s;switch(a){case"root":return e.get(t,o);case"current":return e.get(n,o);default:return null!=(r=e.get(t,o))?r:e.get(n,o)}})(t,n);switch(r){case"eq":return o===a;case"neq":return o!==a;case"lt":return o<a;case"lte":return o<=a;case"gt":return a<o;case"gte":return a<=o;default:return!1}},c=(e,t,n)=>{if(e){if("conditions"in e){const{conditions:r,type:a}=e;return"or"===a?r.some(e=>c(e,t,n)):r.every(e=>c(e,t,n))}return u(e,t,n)}return!0},l={number:s,string:(e,t,n)=>e.next(t,n),boolean:(e,t,n)=>e.nextBoolean(t,n),bit:a,week:(e,t,n)=>a(e,t,n).slice(0,7),enum:(e,t,r)=>{var{extension:a,name:o}=t,t=e.nextNumber(t,r);if(a){const e=a["range"];if(Array.isArray(e)&&e.length)return e.includes(t)?t:(n({type:"warning",message:`解析到属性【${o}】时，得到的值${t}未在可枚举范围内`,data:{[o]:t}}),e[0])}return t},custom:(e,t,r)=>{const{parse:a,name:o}=t,s=e.next(t,r),i=parseInt(s,16);return"function"==typeof a?a(i,s):(n({type:"warning",message:`解析自定义类型属性【${o}】时，检测到未配置 parse 函数`,data:{[o]:i}}),i)},numberBySeparate:(e,t,n)=>{var{extension:r,numType:a="hex"}=t;if(1===o(t,n))return e.nextNumber(t,n);const s=e.next(t,n);let i=0;for(let e=0;e<s.length;e+=2)i+=parseInt(s.slice(e,e+2),"dec"===a?10:16)*Math.pow(10,s.length-2-e);if(r){const{min:e=-1/0,max:t=1/0}=r;return Math.max(Math.min(i,t),e)}return i},default:s},p=(n,e,r)=>{const t=e["childMap"],a={};return t.forEach(e=>{const t=e["condition"];if(c(t,r,a)){const t=m(n,e,a,r);a[e.name]=t}}),a},m=(t,a,o,s)=>{var{type:i="number",loop:u=!1,limit:c,name:m}=a;let h=1;u&&(h=c?"string"==typeof c||Array.isArray(c)?e.get(o,c,0):c:1/0);const g=[];for(let e=0;e<h;e++){if(!t.hasNext()){g.length||g.push(r(a,o)),0===e&&n({type:"warning",message:`解析到属性【${m}】时，发现已无可解析的数据，属性返回默认值`,data:{[m]:u?g:g[0]}});break}var f="child"===i?p(t,a,s):"function"==typeof l[i]?l[i](t,a,o):l.default(t,a,o);g.push(f)}return u?g:g[0]},d=(t,n,r)=>{var a;if(("00"===n||!n)&&"child"===(null==(a=t[0])?void 0:a.type)&&null!=(a=t[0])&&a.loop)return[];const s=(t=>{const u=function*(e){let t,n=0,r="";for(;t=2*(yield r),r=e.substr(n,t),!(n+t>=e.length);)n+=t;return r}(t);u.next();let l=0===t.length;const c=(t,e)=>{if(l)throw new i(i.ALLREADY_TO_END,"已经解析到末尾，无法再解析");const{storageType:n="be"}=t,r=o(t,e),{value:a,done:s}=u.next(r);if(l=s,"le"!==n)return a;{const t=[];for(let e=0;e<a.length;e+=2)t.splice(0,0,a.slice(e,e+2));return t.join("")}},n=(e,t)=>{var{numType:n="hex"}=e;return parseInt(c(e,t),"dec"===n?10:16)};return{next:c,nextNumber:n,nextBoolean:(e,t)=>Boolean(n(e,t)),nextBits:(t,n)=>{const{numType:r="hex",bitType:a="right"}=t,o=c(t,n),s="dec"===r?10:16,i=[];for(let t=0;t<o.length;t+=2){const n=parseInt(o.slice(t,t+2),s),r=e.padStart(n.toString(2),8,"0").split("").map(e=>Number(e));"right"===a&&r.reverse(),i.push(...r)}return i},hasNext:()=>!l}})(n);return t.forEach(e=>{const{name:t,condition:n}=e;if(c(n,r,r)){const n=m(s,e,r,r);r[t]=n}}),r},h=(t,n=1)=>e.padStart(Number(t).toString(16),2*n,"0"),g=(t,n=1)=>e.padStart(Number(t).toString(),2*n,"0"),f=(e,t,n)=>("dec"===n?g:h)(e,t),y=(t,n)=>{if("le"!==n)return t;{const n=[];for(let e=0;e<t.length;e+=2)n.splice(0,0,t.slice(e,e+2));return n.join("")}},x=(e,t,n)=>{var{extension:r,numType:a="hex",storageType:s="be"}=t,t=o(t,n);let i=e;if(r){const{min:e=-1/0,max:t=1/0}=r;i=Math.max(Math.min(i,t),e)}return y(f(i,t,a),s)},b=(t,e,n)=>{const{storageType:r="be",numType:a="hex",bitType:s="right"}=e,i=o(e,n),u=[];for(let e=0;e<i;e++){const n=8*e,r=8*(e+1),o=t.slice(n,r);if(o.length<8){const t=8-o.length;for(let e=0;e<t;e++)o.push(0)}"right"===s&&o.reverse();const i=parseInt(o.join(""),2);u.push(f(i,1,a))}return y(u.join(""),r)},v=(t,r,a)=>{var{storageType:s="be",name:i}=r,r=o(r,a),a=2*r;let u=t;return t.length>a?(n({type:"warning",message:`属性【${i}】转化后的值${t}长度过长，超过${r}个字节`,data:{[i]:t}}),u=t.slice(0,a)):t.length<a&&(n({type:"warning",message:`属性【${i}】转化后的值${t}长度过短，少于${r}个字节`,data:{[i]:t}}),u=e.padStart(t,a,"0")),y(u,s)},w={number:x,string:v,boolean:(e,t,n)=>x(Number(e),t,n),bit:b,week:(e,t,n)=>b([...e,0],t,n),enum:(e,t,r)=>{var{extension:a,name:o}=t;let s=e;if(a){const t=a["range"];Array.isArray(t)&&t.length&&(s=t.includes(e)?e:(n({type:"warning",message:`属性【${o}】的值${e}不在可枚举范围内`,data:{[o]:e}}),t[0]))}return x(s,t,r)},custom:(e,t,r)=>{const{format:a,name:o}=t;let s=null==e?void 0:e.toString();return"function"==typeof a?s=a(e):n({type:"warning",message:`属性【${o}】为自定义类型，检测到未配置 format 处理函数`,data:{[o]:e}}),v(s,t,r)},numberBySeparate:(e,t,n)=>{const{extension:r,numType:a="hex",storageType:s="be"}=t,i=o(t,n);let u=e%Math.pow(10,2*i);if(r){const{min:e=-1/0,max:t=1/0}=r;u=Math.max(Math.min(u,t),e)}const l=[];for(let e=0;e<i;e++){const t=Math.pow(10,2*(i-1-e)),n=Math.floor(u/t),r=("dec"===a?g:h)(n,1);u%=t,"le"===s?l.splice(0,0,r):l.push(r)}return l.join("")},default:x},A=(a,o,t)=>{const s=[];return t.forEach(t=>{var n=t["condition"];c(n,o,a)&&s.push(((t,n,a)=>{var o,{type:s="number",name:i,childMap:u,loop:l=!1,limit:c}=a;let p=1,m=null!=(o=t[i])?o:r(a,t);l?p=c?"string"==typeof c||Array.isArray(c)?e.get(t,c,0):c:m.length:m=[m];const h=[];for(let e=0;e<p;e++){const o=null!=(g=m[e])?g:r(a,t);var g="child"===s?A(o,n,u):"function"==typeof w[s]?w[s](o,a):w.default(o,a,t);h.push(g)}return h.join("")})(a,o,t))}),s.join("")};var N={parse:(e,t)=>d(t,e,{}),format:(e,t)=>{var n;return Array.isArray(e)&&"child"===(null==(n=t[0])?void 0:n.type)&&null!=(n=t[0])&&n.loop?"00":A(e,e,t)},onLog:e=>{t.push(e)},offLog:e=>{e=t.indexOf(e);0<=e&&t.splice(e,1)}};module.exports=N;
//# sourceMappingURL=index.cjs.js.map
