/* eslint-disable no-undef */
import{padStart as e,get as t}from"lodash";const n=[],r=t=>{var e;"development"===(null==(e=null===process||void 0===process?void 0:process.env)?void 0:e.NODE_ENV)&&(console.warn("警告：",t.message),console.warn("相关数据：",t.data)),n.forEach(e=>{e(t)})},o=(t,n)=>{var{defaultValue:r,type:a="number",extension:o}=t;if(void 0!==r)return r;var i=2*s(t,n);switch(a){case"number":case"numberBySeparate":if(o){const e=o["min"];return void 0===e?0:e}return 0;case"string":return e("00",i,"0");case"boolean":return!1;case"enum":if(o){const e=o["range"];return Array.isArray(e)&&e.length?e[0]:0}return 0;case"week":return[0,0,0,0,0,0,0];case"bit":return[...new Array(i).keys()].map(()=>0);case"child":return{};default:return}},s=(e,n)=>{var{bytes:e=1}=e;let r=e;return(r=!Array.isArray(e)&&"string"!=typeof e?r:t(n,e,1))||1},a=(e,t,n)=>{var r=t["extension"],n=e.nextNumber(t,n);if(r){const{min:e=-1/0,max:t=1/0}=r;return Math.max(Math.min(n,t),e)}return n},i=(e,t,n)=>e.nextBits(t,n);class c{constructor(e,t){this.code=e,this.msg=t}}c.ALLREADY_TO_END="endError",c.UNKOWN_CONDITION="unkownConditionError";const u=(s,e,n)=>{var{operation:r="eq",value:a}=s,o=((e,n)=>{var r,{findType:a,prop:o}=s;switch(a){case"root":return t(e,o);case"current":return t(n,o);default:return null!=(r=t(e,o))?r:t(n,o)}})(e,n);switch(r){case"eq":return o===a;case"neq":return o!==a;case"lt":return o<a;case"lte":return o<=a;case"gt":return a<o;case"gte":return a<=o;default:return!1}},l=(e,t,n)=>{if(e){if("conditions"in e){const{conditions:r,type:a}=e;return"or"===a?r.some(e=>l(e,t,n)):r.every(e=>l(e,t,n))}return u(e,t,n)}return!0},p={number:a,string:(e,t,n)=>e.next(t,n),boolean:(e,t,n)=>e.nextBoolean(t,n),bit:i,week:(e,t,n)=>i(e,t,n).slice(0,7),enum:(e,t,n)=>{var{extension:a,name:o}=t,t=e.nextNumber(t,n);if(a){const e=a["range"];if(Array.isArray(e)&&e.length)return e.includes(t)?t:(r({type:"warning",message:`解析到属性【${o}】时，得到的值${t}未在可枚举范围内`,data:{[o]:t}}),e[0])}return t},custom:(e,t,n)=>{const{parse:a,name:o}=t,s=e.next(t,n),i=parseInt(s,16);return"function"==typeof a?a(i,s):(r({type:"warning",message:`解析自定义类型属性【${o}】时，检测到未配置 parse 函数`,data:{[o]:i}}),i)},numberBySeparate:(e,t,n)=>{var{extension:r,numType:a="hex"}=t;if(1===s(t,n))return e.nextNumber(t,n);const o=e.next(t,n);let i=0;for(let e=0;e<o.length;e+=2)i+=parseInt(o.slice(e,e+2),"dec"===a?10:16)*Math.pow(10,o.length-2-e);if(r){const{min:e=-1/0,max:t=1/0}=r;return Math.max(Math.min(i,t),e)}return i},default:a},m=(n,e,r)=>{const t=e["childMap"],a={};return t.forEach(e=>{const t=e["condition"];if(l(t,r,a)){const t=h(n,e,a,r);a[e.name]=t}}),a},h=(n,a,s,i)=>{var{type:u="number",loop:l=!1,limit:e,name:c}=a;let h=1;l&&(h=e?"string"==typeof e||Array.isArray(e)?t(s,e,0):e:1/0);const f=[];for(let e=0;e<h;e++){if(!n.hasNext()){f.length||f.push(o(a,s)),0===e&&r({type:"warning",message:`解析到属性【${c}】时，发现已无可解析的数据，属性返回默认值`,data:{[c]:l?f:f[0]}});break}var g="child"===u?m(n,a,i):"function"==typeof p[u]?p[u](n,a,s):p.default(n,a,s);f.push(g)}return l?f:f[0]},f=(t,n,r)=>{var a;if(("00"===n||!n)&&"child"===(null==(a=t[0])?void 0:a.type)&&null!=(a=t[0])&&a.loop)return[];const o=(t=>{const i=function*(e){let t,n=0,r="";for(;t=2*(yield r),r=e.substr(n,t),!(n+t>=e.length);)n+=t;return r}(t);i.next();let u=0===t.length;const l=(t,e)=>{if(u)throw new c(c.ALLREADY_TO_END,"已经解析到末尾，无法再解析");const{storageType:n="be"}=t,r=s(t,e),{value:a,done:o}=i.next(r);if(u=o,"le"!==n)return a;{const t=[];for(let e=0;e<a.length;e+=2)t.splice(0,0,a.slice(e,e+2));return t.join("")}},n=(e,t)=>{var{numType:n="hex"}=e;return parseInt(l(e,t),"dec"===n?10:16)};return{next:l,nextNumber:n,nextBoolean:(e,t)=>Boolean(n(e,t)),nextBits:(t,n)=>{const{numType:r="hex",bitType:a="right"}=t,o=l(t,n),s="dec"===r?10:16,i=[];for(let t=0;t<o.length;t+=2){const n=parseInt(o.slice(t,t+2),s),r=e(n.toString(2),8,"0").split("").map(e=>Number(e));"right"===a&&r.reverse(),i.push(...r)}return i},hasNext:()=>!u}})(n);return t.forEach(e=>{const{name:t,condition:n}=e;if(l(n,r,r)){const n=h(o,e,r,r);r[t]=n}}),r},d=(t,n=1)=>e(Number(t).toString(16),2*n,"0"),g=(t,n=1)=>e(Number(t).toString(),2*n,"0"),y=(e,t,n)=>("dec"===n?g:d)(e,t),x=(t,n)=>{if("le"!==n)return t;{const n=[];for(let e=0;e<t.length;e+=2)n.splice(0,0,t.slice(e,e+2));return n.join("")}},b=(e,t,n)=>{var{extension:r,numType:a="hex",storageType:o="be"}=t,t=s(t,n);let i=e;if(r){const{min:e=-1/0,max:t=1/0}=r;i=Math.max(Math.min(i,t),e)}return x(y(i,t,a),o)},v=(t,e,n)=>{const{storageType:r="be",numType:a="hex",bitType:o="right"}=e,i=s(e,n),u=[];for(let e=0;e<i;e++){const n=8*e,r=8*(e+1),s=t.slice(n,r);if(s.length<8){const t=8-s.length;for(let e=0;e<t;e++)s.push(0)}"right"===o&&s.reverse();const i=parseInt(s.join(""),2);u.push(y(i,1,a))}return x(u.join(""),r)},w=(t,n,a)=>{var{storageType:o="be",name:i}=n,n=s(n,a),a=2*n;let u=t;return t.length>a?(r({type:"warning",message:`属性【${i}】转化后的值${t}长度过长，超过${n}个字节`,data:{[i]:t}}),u=t.slice(0,a)):t.length<a&&(r({type:"warning",message:`属性【${i}】转化后的值${t}长度过短，少于${n}个字节`,data:{[i]:t}}),u=e(t,a,"0")),x(u,o)},A={number:b,string:w,boolean:(e,t,n)=>b(Number(e),t,n),bit:v,week:(e,t,n)=>v([...e,0],t,n),enum:(e,t,n)=>{var{extension:a,name:o}=t;let s=e;if(a){const t=a["range"];Array.isArray(t)&&t.length&&(s=t.includes(e)?e:(r({type:"warning",message:`属性【${o}】的值${e}不在可枚举范围内`,data:{[o]:e}}),t[0]))}return b(s,t,n)},custom:(e,t,n)=>{const{format:a,name:o}=t;let s=null==e?void 0:e.toString();return"function"==typeof a?s=a(e):r({type:"warning",message:`属性【${o}】为自定义类型，检测到未配置 format 处理函数`,data:{[o]:e}}),w(s,t,n)},numberBySeparate:(e,t,n)=>{const{extension:r,numType:a="hex",storageType:o="be"}=t,i=s(t,n);let u=e%Math.pow(10,2*i);if(r){const{min:e=-1/0,max:t=1/0}=r;u=Math.max(Math.min(u,t),e)}const l=[];for(let e=0;e<i;e++){const t=Math.pow(10,2*(i-1-e)),n=Math.floor(u/t),r=("dec"===a?g:d)(n,1);u%=t,"le"===o?l.splice(0,0,r):l.push(r)}return l.join("")},default:b},N=(r,a,e)=>{const s=[];return e.forEach(e=>{var n=e["condition"];l(n,a,r)&&s.push(((n,r,a)=>{var s,{type:i="number",name:e,childMap:u,loop:l=!1,limit:c}=a;let p=1,m=null!=(s=n[e])?s:o(a,n);l?p=c?"string"==typeof c||Array.isArray(c)?t(n,c,0):c:m.length:m=[m];const h=[];for(let e=0;e<p;e++){const s=null!=(f=m[e])?f:o(a,n);var f="child"===i?N(s,r,u):"function"==typeof A[i]?A[i](s,a):A.default(s,a,n);h.push(f)}return h.join("")})(r,a,e))}),s.join("")};var T={parse:(e,t)=>f(t,e,{}),format:(e,t)=>{var n;return Array.isArray(e)&&"child"===(null==(n=t[0])?void 0:n.type)&&null!=(n=t[0])&&n.loop?"00":N(e,e,t)},onLog:e=>{n.push(e)},offLog:e=>{e=n.indexOf(e);0<=e&&n.splice(e,1)}};export{T as default};
//# sourceMappingURL=index.esm.js.map
